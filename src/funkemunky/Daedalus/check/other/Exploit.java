package funkemunky.Daedalus.check.other;

import org.bukkit.Material;
import org.bukkit.enchantments.Enchantment;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.player.PlayerEditBookEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.BookMeta;

import funkemunky.Daedalus.Daedalus;
import funkemunky.Daedalus.check.Check;
import funkemunky.Daedalus.utils.Chance;

public class Exploit extends Check {

	public Exploit(Daedalus Daedalus) {
		super("Exploit", "Exploit", Daedalus);

		setEnabled(true);
		setBannable(false);
		setMaxViolations(1);
	}

	@EventHandler
	public void onDamage(PlayerInteractEvent event) {
		Player attacker = event.getPlayer();
		@SuppressWarnings("deprecation")
		ItemStack is = attacker.getItemInHand();
		if (is == null) {
			return;
		}
		if ((is.getType() != Material.BOOK_AND_QUILL) && (is.getType() != Material.WRITTEN_BOOK)) {
			return;
		}
		if (is.getEnchantments().size() > 0) {
			for (Enchantment ench : is.getEnchantments().keySet()) {
				is.removeEnchantment(ench);
			}

			event.setCancelled(true);
			getDaedalus().logCheat(this, attacker, "Book and Quill Exploit", Chance.LIKELY, new String[0]);
			attacker.getInventory().removeItem(new ItemStack[] { is });
		}
	}

	@EventHandler
	public void onEdit(PlayerEditBookEvent event) {
		BookMeta book = event.getNewBookMeta();
		if (book.getEnchants().size() > 0) {
			event.setCancelled(true);
			event.getPlayer().getInventory().remove(Material.BOOK_AND_QUILL);
			getDaedalus().logCheat(this, event.getPlayer(), "Book and Quill Exploit", Chance.LIKELY, new String[0]);
		}
	}

}
